<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<base href="https://beta.01p-w.com/"> 
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>01p-w</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta content="01p-w is the outcome of an in-depth research about the essence of photography, its influence on the construction of identity and the instruments for archiving imagery
	in the past and athe present. 01p-w is neither a further social network nor another app to publicly exhibit your private photos – 01p-w does just the opposite. It stands
	for radical limitation in a world of unlimited noise, for a conscious engagement with photography; a medium once a word of almost magical properties described as an
	emanation of reality."
    name="description">
  <meta content="01p-w" name="author">
  <meta content="https://01p-w.com/img/fb.png" property="og:image">
  <meta content="01p-w" property="og:title">
  <meta content="https://01p-w.com" property="og:url">
  <meta content="01p-w is the outcome of an in-depth research about the essence of photography, its influence on the construction of identity and the instruments for archiving imagery
	in the past and the present. 01p-w is neither a further social network nor another app to publicly exhibit your private photos – 01p-w does just the opposite. It stands
	for radical limitation in a world of unlimited noise, for a conscious engagement with photography; a medium once a word of almost magical properties described as an
  emanation of reality."
    property="og:description">
 <!--<link href="./css/style.css" rel="stylesheet">-->
<link href="https://01p-w.com/style_beta.css" rel="stylesheet">
  <link href="./favicon.png" rel="shortcut icon">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
  <script defer src="./js/fullscreen.js"></script>

  <!-- update the version number as needed -->
  <script defer src="https://www.gstatic.com/firebasejs/5.5.6/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="https://www.gstatic.com/firebasejs/5.5.6/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/5.5.6/firebase-storage.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/5.5.6/firebase-firestore.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="./js/init.js"></script>
</head>

<body>
  <header>
    <h1 id="logo">
      <a href="/" alt="Home">01p-w</a>
    </h1>
    <h1 id="user" class="hidden"></h1>
    <h1 id="login">
      <a onclick="toggleUIElement('#loginfield')">Sign In</a>
    </h1>
  </header>
  <div id="optionbar" class="optionbar hidden">
    <div class="optionbar--left">
      <div><a id="support" class="pointer" href="mailto:support@01p-w.com">Support</a></div>
      <div><a id="termsofuselink" class="pointer" onclick="showTermsOfUse()">Terms of use</a></div>
      <div><a id="privacypolicylink" class="pointer" onclick="showPrivacyPolicy()">Privacy Policy</a></div>
    </div>
    <div class="optionbar--right">
      <div><a class="pointer" onclick="showSettings()">Settings</a></div>
      <div><a class="pointer" onclick="signOut()">Log out</a></div>
    </div>
  </div>
  <div id="description">
    <p>01p-w is the outcome of an in-depth research about the essence of photography, its influence on the construction
      of identity
      and the instruments for archiving imagery in the past and the present. 01p-w is neither an additional social
      network
      nor another app to publicly exhibit your private photos&mdash;01p-w does just the opposite. It stands for radical
      limitation
      in a world of unlimited noise, for conscious engagement with photography; a medium once a word of almost magical
      properties,
      described as an emanation of reality.</p>
  </div>
  <div id="termsofuse" class="dialog fullpagetext hidden">
    <div id="closecross">
      <a onclick="toggleUIElement('#termsofuse')">
        <img src="img/greycross.png" />
      </a>
    </div>
    <p>Terms of use: 01p-w users: As of May 29, 2018, Fantastic Fox, Inc. has acquired Flickr. Your continued use of
      the Flickr
      services will be subject to these Terms of Use. These Terms of Use also apply to your use of the Services,
      where applicable, to purchase photographic prints, videos or other related merchandise, products and
      services (“Products”) through Flickr’s approved third party vendors and retailers (“Flickr Vendors”). For infor-
      mation about how Flickr collects, uses and discloses your information, please see the Flickr Pr</p>
  </div>
  <div id="privacypolicy" class="dialog fullpagetext hidden">
    <div id="closecross">
      <a onclick="toggleUIElement('#privacypolicy')">
        <img src="img/greycross.png" />
      </a>
    </div>
    <p>Privacy Policy: 01p-w users: As of May 29, 2018, Fantastic Fox, Inc. has acquired Flickr. Your continued use of
      the Flickr
      services will be subject to these Terms of Use. These Terms of Use also apply to your use of the Services,
      where applicable, to purchase photographic prints, videos or other related merchandise, products and
      services (“Products”) through Flickr’s approved third party vendors and retailers (“Flickr Vendors”). For infor-
      mation about how Flickr collects, uses and discloses your information, please see the Flickr Pr</p>
  </div>
  <div id="loginfield" class="up hidden">
    <div id="lfield">
      <div id="closecross">
        <a onclick="closeSignIn()">
          <img src="img/greycross.png" />
        </a>
      </div>
      <form name="login" id="loginform" onsubmit="signIn(event)">
        <table>
          <tr>
            <td>Email
              <br>
              <input id="login_email" type="email" name="email" required>
            </td>
          </tr>
          <tr>
            <td>Password
              <span id="forgotpw">
                <a class="pointer" onclick="showForgotPwForm()">Forgot it?</a>
              </span>
              </br>
              <input id="login_password" type="password" name="password" required>
            </td>
          </tr>
          <tr>
            <td>
              <div id="rememberme" class="checkbox">

                <input type="checkbox" id="rememberme" name="rememberme" />
                <label for="rememberme">
                  Remember me</label>
              </div>
              <div class="submit">
                <input type="submit" class="submitbutton" value="Login">
              </div>
            </td>
          </tr>
        </table>
      </form>
      <div id="forgotpwForm" class="hidden">
        <div id="forgotpwInput">
          <span>Please enter the email address you use
            to log in, and we’ll send you a link to reset
            your password.</span>
          <table>
            <tr>
              <td>Email
                <br>
                <input id="forgotpw_email" type="email" name="email" required>
              </td>
            </tr>
            <tr>
              <td>
                <div class="submit">
                  <input type="button" class="submitbutton" onclick="resetPassword()" value="Reset Password">
                  <p id="forgotpw_error"></p>
                </div>
              </td>
            </tr>
          </table>
        </div>
        <span id="afterreset"></span>
      </div>
      <div>
        <p id="login_error"></p>
        <span id="resendEmail" class="hidden">
          <a class="pointer" onclick="resendVerificationEmail()">Resend verification email</a>
        </span>
      </div>
    </div>
    <div id="rfield">
      <div id="registrationFormContainer">
        <form name="registration" id="registrationform" onsubmit="signUp(event)">
          <table>
            <tr>
              <td>
                <h2>Create an account</h2>
              </td>
            </tr>
            <tr>
              <td>First name
                <br>
                <input id="signup_firstname" type="text" name="firstname" required>
              </td>
            </tr>
            <tr>
              <td>Last name
                <br>
                <input id="signup_lastname" type="text" name="lastname" required>
              </td>
            </tr>
            <tr>
              <td>Email
                <br>
                <input id="signup_email" type="email" name="email" required>
              </td>
            </tr>
            <tr>
              <td>Confirm email
                <br>
                <input id="signup_confirmemail" type="email" name="confirmemail" required>
              </td>
            </tr>
            <tr>
              <td>Password
                <br>
                <input id="signup_password" type="password" name="password" required>
              </td>
            </tr>
            <tr>
              <td>Confirm password
                <br>
                <input id="signup_confirmpassword" type="password" name="confirmpassword" required>
              </td>
            </tr>
            <tr>
              <td>
                <div id="policy" class="checkbox">
                  <input id="signup_policy" type="checkbox" name="policy" />
                  <label for="policy">
                    I accept and have read the privacy
                    <br>policy and the membership policy.</label>
                </div>
                <div class="submit">
                  <input type="submit" class="submitbutton" value="Sign up">
                </div>
              </td>
            </tr>
          </table>
        </form>
        <div>
          <p id="signup_error"></p>
        </div>
      </div>
      <div id="emailVerification" class="hidden">
        <p>Your account has been successfully created. Please check your inbox to confirm your address.</p>
        <p>Didn't receive the email?<a class="pointer" onclick="resendVerificationEmail()">Resend
            now</a></p>
      </div>
    </div>
  </div>
  <div id="profilefield" class="dialog up hidden">
    <div id="closecross">
      <a onclick="toggleUIElement('#profilefield')">
        <img src="img/greycross.png" />
      </a>
    </div>
    <div id="profilefieldform">
      <form name="profilesettings" id="settingform" onsubmit="updateProfile(event)">
        <table>
          <tr>
            <td>
              <h2>Edit your preferences below.</h2>
            </td>
          </tr>
          <tr>
            <td>First name
              <br>
              <input id="setting_firstname" type="text" name="firstname" required>
            </td>
          </tr>
          <tr>
            <td>Last name
              <br>
              <input id="setting_lastname" type="text" name="lastname" required>
            </td>
          </tr>
          <tr>
            <td>Email
              <br>
              <input id="setting_email" type="email" name="email" required>
            </td>
          </tr>
          <tr>
            <td>Old password
              <br>
              <input id="setting_oldpassword" type="password" name="password" required>
            </td>
          </tr>
          <tr>
            <td>Password
              <br>
              <input id="setting_password" type="password" name="password" required>
            </td>
          </tr>
          <tr>
            <td>Confirm password
              <br>
              <input id="setting_confirmpassword" type="password" name="confirmpassword" required>
            </td>
          </tr>
          <tr>
            <td>
              <div class="submit">
                <input type="submit" class="submitbutton" value="Save changes">
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <a class="pointer" onclick="showDeleteAccount()">Delete account?</a>
              <p id="showDeleteAccount_error"></p>
            </td>
          </tr>
        </table>
      </form>
      <div>
        <p id="setting_error"></p>
      </div>
    </div>
    <div id="deleteAccount" class="hidden">
      <p>Are you sure you want to delete your account?</p>
      <p>Keep in mind that you will not be able to reactivate your account or retrieve any of the data you have added.
        A link to download your archive will be sent to you by email after your confirmation.</p>
      <input type="button" onclick="deleteAccount()" value="Delete account">
      <input type="button" onclick="cancelDeleteAccount()" value="Cancel">
      <p id="deleteAccount_error"></p>
    </div>
  </div>
  <div id="templateContainer"></div>
  <script id="entry-template" type="text/x-handlebars-template">
  <div id="captionbar" class="captionbar hidden">
    <div class="captionbar--left">
      <div onclick="$('#week').toggleClass('visible');" id="currentweek" class="captionbar-button">All</div>
      <div onclick="$('#year').toggleClass('visible');" id="currentyear" class="captionbar-button">2018</div>
      <ul class="dropdown" id="week">
        {{#each weeks}}
        <a class="dropdownWeekItem dropdownWeekItem-{{year}} {{hidden}}" onclick="showSingle(event, '{{id}}', '{{caption}}')" alt="{{label}}">
          <li>{{label}}</li>
        </a>
        {{/each}}
      </ul>
      <ul class="dropdown" id="year">
        {{#each years}}
        <a onclick="changeYear(event, '{{year}}')" alt="{{year}}">
          <li>{{year}}</li>
        </a>
        {{/each}}
      </ul>
    </div>
    <div id="caption" class="captionbar-center hidden">
      <div id="captionInput">
        <input type="text"  id="captionInputElement" onkeyup="captionInputTextInserted()" onfocus="$('#captionSaveButton').removeClass('hidden')" placeholder="Insert caption here"/>
        <input type="button" id="captionSaveButton" class="hidden" value="Save" onclick="saveCaption(event)" disabled/> 
      </div>
      <div id="captionText"></div>
    </div>
    <div class="captionbar--right">
      <div class="captionbar-button fullscreen"></div>
      <div class="captionbar-button galeriebutton"></div>
    </div>
  </div>
  <div id="gallery" class="hidden">
      {{#each images}}
        {{#if downloadUrl}}
          <article id="imageDialog-{{id}}" onclick="showSingle(event, '{{id}}', '{{caption}}')" class="image" data-piio-bck="{{downloadUrl}}">
            <div class="imageoption">
              <p class="number">{{label}}</p>
              <div class="buttons">
                <button class="deletesingle" onclick="showDeleteImage(event, '{{id}}')"></button>
                <button class="downloadsingle" onclick="event.stopPropagation()"><a href="{{downloadUrl}}" download></a></button>
              </div>
            </div>
          </article>
          <article id="deleteImageDialog-{{id}}" class="image hidden" style="background-color: #9e9e9e;">
            <div class="deletemessage">Are you sure you want to delete this image?<br>
              <button class="submitbutton" data-id="{{id}}" onclick="deleteImage(event)">Yes</button>
              <button class="submitbutton" onclick="hideDeleteImage(event, '{{id}}')">No</button>
            </div>
          </article>
        {{else}}
        <article id="addImageDialog-{{id}}" class="image" style="background-color: #9e9e9e;" onclick="document.querySelector('#addimageinput-{{id}}').click();">
          <div class="imageoption">
            <p class="number">{{label}}</p>
          </div>
          <div id="addimageelement">
            <input type="file" id="addimageinput-{{id}}" class="hidden" name="image" accept="image/*" data-id="{{id}}" onchange="addImage(event)">
            <span>+</span>
          </div>
        </article>
        {{/if}}
      {{/each}}
  </div>
  <div id="single" class="hidden">
    {{#each singleImages}}
    <div id="single-{{id}}" class="hidden">
      <article class="image" data-piio-bck="{{downloadUrl}}"></article>
      <ul>
        <li class="prev">
          <a onclick="showSingle(event, '{{prevId}}', '{{prevCaption}}')"></a>
        </li>
        <li class="next">
          <a onclick="showSingle(event, '{{nextId}}', '{{nextCaption}}')"></a>
        </li>
      </ul>
    </div>
    {{/each}}
  </div>
  </script>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        let app = firebase.app();
        const firestore = firebase.firestore();
        const settings = { timestampsInSnapshots: true };
        firestore.settings(settings);
        firebase.auth().onAuthStateChanged((user) => {
          if (user && user.emailVerified) {
            toggleUI();
            document.querySelector("#user").textContent = user.displayName;
            getImagesByUserId(user.uid);
          }
        });
      } catch (error) {
        console.error(`(error): ${JSON.stringify(error)}`);
      }
    });

    function signIn(event) {
      event.preventDefault();
      const email = document.querySelector("#login_email").value;
      const password = document.querySelector("#login_password").value;
      firebase.auth().signInWithEmailAndPassword(email, password).then(function () {
        var currentUser = firebase.auth().currentUser;
        document.querySelector("#login_email").value = "";
        document.querySelector("#login_password").value = "";
        if (currentUser.emailVerified) {
          toggleUIElement("#loginfield");
        } else {
          document.querySelector("#login_error").innerHTML = "Email address is not verified yet. Please check your inbox to confirm your address.";
          toggleUIElement("#resendEmail");
        }
      }).catch((error) => {
        console.error(`(signIn): (${error.code}) ${error.message}`);
        document.querySelector("#login_error").innerHTML = "Sorry we couldn't find you.</p> Please try again.";
      });
    }

    function resendVerificationEmail() {
      var currentUser = firebase.auth().currentUser;
      currentUser.sendEmailVerification();
    }

    function closeSignIn() {
      toggleUIElement('#loginfield');
      document.querySelector("#loginform").classList.remove("hidden");
      document.querySelector("#forgotpwForm").classList.add("hidden");
      document.querySelector("#forgotpwInput").classList.remove("hidden");
      document.querySelector("#afterreset").innerHTML = "";
      document.querySelector("#forgotpw_email").value = "";
      document.querySelector("#forgotpw_error").innerHTML = "";
      document.querySelector("#registrationFormContainer").classList.remove("hidden");
      document.querySelector("#emailVerification").classList.add("hidden");
      document.querySelector("#signup_error").innerHTML = "";
      document.querySelector("#login_error").innerHTML = "";
      document.querySelector("#resendEmail").classList.add("hidden");
    }

    function showForgotPwForm() {
      toggleUIElement("#loginform");
      toggleUIElement("#forgotpwForm");
    }

    function resetPassword() {
      var emailAddress = document.querySelector("#forgotpw_email").value;
      if (emailAddress !== "") {
        var auth = firebase.auth();
        auth.sendPasswordResetEmail(emailAddress).then(function () {
          document.querySelector("#forgotpw_error").innerHTML = "";
          document.querySelector("#afterreset").innerHTML = `Thank you! An email has been sent to ${emailAddress} containing a link to reset your password.`;
          document.querySelector("#forgotpw_email").value = "";
          document.querySelector("#forgotpwInput").classList.add("hidden");
        }).catch(function (error) {
          console.error(`(reset password): (${error.code}) ${error.message}`);
          document.querySelector("#forgotpw_error").innerHTML = "An error occured while resetting your password. Please try again.";
          document.querySelector("#forgotpw_email").value
        });
      } else {
        document.querySelector("#forgotpw_error").innerHTML = "Please enter a valid email address."
      }
    }

    function showTermsOfUse() {
      toggleUIElement('#termsofuse');
      document.querySelector("#privacypolicy").classList.add("hidden");
    }

    function showPrivacyPolicy() {
      toggleUIElement('#privacypolicy');
      document.querySelector("#termsofuse").classList.add("hidden");
    }

    function toggleUIElement(element) {
      if (document.querySelector(element)) {
        document.querySelector(element).classList.toggle("hidden");
      }
    }

    function showSingle(event, id, caption) {
      if (event) {
        event.stopPropagation();
      }
      window.singleElementPage = id;
      $("#caption").removeClass("hidden");
      $('#week').removeClass('visible');
      $("#single > div").each(function () {
        $(this).addClass("hidden");
      });
      if (id) {
        $("#gallery").addClass("hidden");
        $(`#single`).removeClass("hidden");
        $(`#single-${id}`).removeClass("hidden");
        if (caption !== "") {
          $("#captionInput").addClass("hidden");
          $("#captionText").removeClass("hidden");
          $("#captionText").text(caption);
        } else {
          $("#captionInput").removeClass("hidden");
          $("#captionText").addClass("hidden");
          $("#captionInputElement").data("id", id);
        }
      } else {
        // when all is clicked
        window.singleElementPage = undefined;
        $("#caption").addClass("hidden");
        $("#gallery").removeClass("hidden");
        $(`#single`).addClass("hidden");
      }
    }

    async function saveCaption(event) {
      event.preventDefault();
      event.stopPropagation();
      const id = $("#captionInputElement").data("id");
      const caption = $("#captionInputElement").val();
      await firebase.firestore().collection("images").doc(id).update({
        caption: caption
      });
    }

    function captionInputTextInserted() {
      if ($("#captionInputElement").val().length !== 0) {
        $("#captionSaveButton").attr('disabled', false);
      } else {
        $("#captionSaveButton").attr('disabled', true);
      }
    }

    function changeYear(event, year) {
      event.stopPropagation();
      $('#week').toggleClass('visible');
      $('#year').toggleClass('visible');
      $(`.dropdownWeekItem`).addClass('hidden');
      $(`.dropdownWeekItem-`).removeClass('hidden');
      $(`.dropdownWeekItem-${year}`).removeClass('hidden');
    }

    function signOut() {
      firebase.auth().signOut().then(function () {
        toggleUI();
        hideUI();
        removeEventListeners();
      });
    }

    function signUp(event) {
      event.preventDefault();
      const user = {
        firstname: document.querySelector("#signup_firstname").value,
        lastname: document.querySelector("#signup_lastname").value,
        email: document.querySelector("#signup_email").value,
        confirmemail: document.querySelector("#signup_confirmemail").value,
        password: document.querySelector("#signup_password").value,
        confirmpassword: document.querySelector("#signup_confirmpassword").value,
        policy: document.querySelector("#signup_policy").checked
      };

      if (validateSignUpForm(user)) {
        firebase.auth().createUserWithEmailAndPassword(user.email, user.password).then(function () {
          var currentUser = firebase.auth().currentUser;
          currentUser.updateProfile({
            displayName: `${user.firstname} ${user.lastname}`
          });
          document.querySelector("#signup_firstname").value = "";
          document.querySelector("#signup_lastname").value = "";
          document.querySelector("#signup_email").value = "";
          document.querySelector("#signup_confirmemail").value = "";
          document.querySelector("#signup_password").value = "";
          document.querySelector("#signup_confirmpassword").value = "";
          currentUser.sendEmailVerification().then(function () {
            toggleUIElement("#registrationFormContainer");
            toggleUIElement("#emailVerification");
          }).catch(function (error) {
            console.error(`(send verification email): (${error.code}) ${error.message}`);
            signup_error("An error happend while sending the verification email. Please try to register again.");
          });

        }).catch((error) => {
          document.querySelector("#signup_firstname").value = "";
          document.querySelector("#signup_lastname").value = "";
          document.querySelector("#signup_email").value = "";
          document.querySelector("#signup_confirmemail").value = "";
          document.querySelector("#signup_password").value = "";
          document.querySelector("#signup_confirmpassword").value = "";
          console.error(`(signUp): (${error.code}) ${error.message}`);
          signup_error("The user already exists. Please log in</br>or sign up with a new account.");
        });

      }
    }

    function validateSignUpForm(user) {
      if (!user.firstname || !user.lastname || !user.email || !user.confirmemail || !user.password || !user.confirmpassword) {
        signup_error("Please fill out all the fields");
        return false;
      }
      if (user.email !== user.confirmemail) {
        signup_error("Email adresses don't match");
        return false;
      }
      if (user.password !== user.confirmpassword) {
        signup_error("Passwords don't match");
        return false;
      }
      if (user.policy !== true) {
        signup_error("Privacy and membership policy must be accepted");
        return false;
      }
      return true;
    }

    function signup_error(message) {
      document.querySelector("#signup_error").innerHTML = message;
    }

    function showSettings() {
      var user = firebase.auth().currentUser;
      var username = user.displayName.split(" ");
      document.querySelector("#setting_firstname").value = username[0];
      document.querySelector("#setting_lastname").value = username[1];
      document.querySelector("#setting_email").value = user.email;
      toggleUIElement('#profilefield');
      document.querySelector("#profilefieldform").classList.remove("hidden");
      document.querySelector("#deleteAccount").classList.add("hidden");
      document.querySelector("#showDeleteAccount_error").innerHTML = "";
      document.querySelector("#deleteAccount_error").innerHTML = "";
    }

    function updateProfile(event) {
      event.preventDefault();
      const user = {
        firstname: document.querySelector("#setting_firstname").value,
        lastname: document.querySelector("#setting_lastname").value,
        email: document.querySelector("#setting_email").value,
        oldpassword: document.querySelector("#setting_oldpassword").value,
        password: document.querySelector("#setting_password").value,
        confirmpassword: document.querySelector("#setting_confirmpassword").value
      };

      if (validateSettingForm(user)) {
        var currentUser = firebase.auth().currentUser;
        let username = `${user.firstname} ${user.lastname}`
        var credentials = firebase.auth.EmailAuthProvider.credential(
          currentUser.email,
          user.oldpassword
        );
        if (currentUser.displayName !== username) {
          currentUser.updateProfile({
            displayName: username
          }).then(function () {
            document.querySelector("#user").textContent = username;
          }).catch(function (error) {
            console.error(`(updateProfile): (${error.code}) ${error.message}`);
            setting_error("Updating the username failed. Please try again.");
          });
        }
        if (currentUser.email !== user.email) {
          currentUser.reauthenticateAndRetrieveDataWithCredential(credentials).then(function () {
            currentUser.updateEmail(user.email).then(function () {
              signOut();
            }).catch(function (error) {
              console.error(`(updateProfile): (${error.code}) ${error.message}`);
              setting_error("Updating the email address failed. Please try again.");
            });
          }).catch(function (error) {
            console.error(`(updateProfile): (${error.code}) ${error.message}`);
          });
        }
        currentUser.reauthenticateAndRetrieveDataWithCredential(credentials).then(function () {
          currentUser.updatePassword(user.password).then(function () {
            // Update successful.
          }).catch(function (error) {
            console.error(`(updateProfile): (${error.code}) ${error.message}`);
            setting_error("Updating the password failed. Please try again.");
          });
        }).catch(function (error) {
          console.error(`(updateProfile): (${error.code}) ${error.message}`);
        });

        document.querySelector("#setting_oldpassword").value = "";
        document.querySelector("#setting_password").value = "";
        document.querySelector("#setting_confirmpassword").value = "";
        setting_error("");
      }
    }

    function validateSettingForm(user) {
      if (!user.firstname || !user.lastname || !user.email || !user.password || !user.confirmpassword) {
        setting_error("Please fill out all the fields");
        return false;
      }
      if (user.password !== user.confirmpassword) {
        setting_error("Passwords don't match");
        return false;
      }
      return true;
    }

    function setting_error(message) {
      document.querySelector("#setting_error").innerHTML = message;
    }

    function showDeleteAccount() {
      if (document.querySelector("#setting_oldpassword").value !== "") {
        toggleUIElement("#profilefieldform");
        toggleUIElement("#deleteAccount");
      } else {
        document.querySelector("#showDeleteAccount_error").innerHTML = "Please enter your old password to delete your account.";
      }
    }

    function cancelDeleteAccount() {
      toggleUIElement("#profilefieldform");
      toggleUIElement("#deleteAccount");
      document.querySelector("#deleteAccount_error").innerHTML = "";
      document.querySelector("#showDeleteAccount_error").innerHTML = "";
    }

    function deleteAccount() {
      var currentUser = firebase.auth().currentUser;
      var credentials = firebase.auth.EmailAuthProvider.credential(
        currentUser.email,
        document.querySelector("#setting_oldpassword").value
      );
      currentUser.reauthenticateAndRetrieveDataWithCredential(credentials).then(function () {
        currentUser.delete().then(function () {
          signOut();
          document.querySelector("#setting_oldpassword").value = "";
        }).catch(function (error) {
          console.error(`(deleteAccount): (${error.code}) ${error.message}`);
          document.querySelector("#deleteAccount_error").innerHTML = "Deleteing your account failed. Please try again.";
        });
      }).catch(function (error) {
        console.error(`(deleteAccount): (${error.code}) ${error.message}`);
        document.querySelector("#deleteAccount_error").innerHTML = "Deleteing your account failed. Please try again.";
      });
    }

    function toggleUI() {
      const elements = ["#user", "#login", "#logout", "#popup", "#description", "#gallery", "#optionbar"];
      for (const element of elements) {
        if (document.querySelector(element)) {
          document.querySelector(element).classList.toggle("hidden");
        }
      }
    }

    function hideUI() {
      const elements = ["#profilefield", "#privacypolicy", "#termsofuse"];
      for (const element of elements) {
        if (document.querySelector(element)) {
          document.querySelector(element).classList.add("hidden");
        }
      }
    }

    function getImagesByUserId(userId) {
      const yearAndWeek = getYearAndWeek(new Date());
      const currentWeek = yearAndWeek[1];
      const currentYear = yearAndWeek[0];
      const ref = firebase.firestore().collection("images").where("uid", "==", userId).orderBy("year", "desc").orderBy("week", "desc");
      ref.get().then(async (querySnapshot) => {
        if (querySnapshot.size === 0) {
          for (let i = 0; i < 7; i++) {
            await createImage(currentWeek - i, currentYear.toString());
          }
        } else {
          const firstDoc = querySnapshot.docs[0].data();
          // if most actual document is not the current week
          if (firstDoc.year === currentYear && firstDoc.week !== currentWeek) {
            const numberOfWeeks = currentWeek - firstDoc.week;
            for (let i = 0; i < numberOfWeeks; i++) {
              await createImage(currentWeek - i, currentYear.toString());
            }
          } else if (firstDoc.year !== currentYear && firstDoc.week !== currentWeek) {
            for (let i = 0; i < currentWeek; i++) {
              await createImage(currentWeek - i, currentYear.toString());
            }
          }
        }
        ref.onSnapshot(async (querySnapshot) => {
          const images = [];
          const singleImages = [];
          const weeks = [];

          weeks.push({
            label: "All",
            hidden: ""
          });
          const yearsSet = new Set();

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const label = getLabel(data.week);
            if (data.downloadUrl !== undefined && data.downloadUrl !== "") {
              singleImages.push(Object.assign({}, data, { id: doc.id, label: label }));
              const hidden = currentYear.toString() === data.year ? "" : "hidden";
              weeks.push({
                id: doc.id,
                label: label,
                year: data.year,
                caption: data.caption,
                hidden: hidden
              });
            }
            images.push(Object.assign({}, data, { id: doc.id, label: label }));
            yearsSet.add(data.year);
          });

          for (let i = 0; i < singleImages.length; i++) {
            if (singleImages.length === 1) {
              singleImages[0].prevId = singleImages[0].id;
              singleImages[0].nextId = singleImages[0].id;
              singleImages[0].prevCaption = singleImages[0].caption;
              singleImages[0].nextCaption = singleImages[0].caption;
            } else {
              if (i === 0) {
                singleImages[i].prevId = singleImages[singleImages.length - 1].id;
                singleImages[i].nextId = singleImages[i + 1].id;
                singleImages[i].prevCaption = singleImages[singleImages.length - 1].caption;
                singleImages[i].nextCaption = singleImages[i + 1].caption;
              } else if (i === singleImages.length - 1) {
                singleImages[i].prevId = singleImages[i - 1].id;
                singleImages[i].nextId = singleImages[0].id;
                singleImages[i].prevCaption = singleImages[i - 1].caption;
                singleImages[i].nextCaption = singleImages[0].caption;
              } else {
                singleImages[i].prevId = singleImages[i - 1].id;
                singleImages[i].nextId = singleImages[i + 1].id;
                singleImages[i].prevCaption = singleImages[i - 1].caption;
                singleImages[i].nextCaption = singleImages[i + 1].caption;
              }
            }
          }

          const years = [];
          for (let year of yearsSet) years.push({ year: year });

          const context = {
            images: images,
            singleImages: singleImages,
            weeks: weeks,
            years: years
          };
          if (!window.handlebarsTemplate) {
            window.handlebarsTemplate = document.querySelector("#entry-template").innerHTML;
          }
          const template = Handlebars.compile(window.handlebarsTemplate);
          document.querySelector("#templateContainer").innerHTML = template(context);
          toggleUIElement("#gallery");
          toggleUIElement("#captionbar");
          addEventListeners();
          if (window.singleElementPage !== undefined) {
            const image = context.images.find((image) => image.id === window.singleElementPage);
            showSingle(null, window.singleElementPage, image.caption);
          }
        });
      });

    }

    function getLabel(index) {
      let label = "";
      if (index < 9) {
        label = "0" + index;
      } else {
        label = label + index;
      }
      return label;
    }

    async function createImage(week, year) {
      try {
        await firebase.firestore().collection("images").add({
          uid: firebase.auth().currentUser.uid,
          week: week,
          year: year
        });
      } catch (error) {
        console.error(`(error): ${JSON.stringify(error)}`);
      }
    }

    async function addImage(event) {
      try {
        event.preventDefault();
        event.stopPropagation();
        const file = document.querySelector(`#addimageinput-${event.target.dataset.id}`).files[0];
        const storageRef = firebase.storage().ref();
        const yearAndWeek = getYearAndWeek(new Date());
        const fileName = `${firebase.auth().currentUser.uid}/${yearAndWeek[0]}/${yearAndWeek[1]}-${getUUID()}`;
        const snapshot = await storageRef.child(fileName).put(file, {
          contentDisposition: `attachment; filename="${file.name}"`
        });
        const downloadUrl = await snapshot.ref.getDownloadURL();
        await firebase.firestore().collection("images").doc(event.target.dataset.id).update({
          imagePath: snapshot.ref.fullPath,
          downloadUrl: downloadUrl
        });
      } catch (error) {
        console.error(`(error): ${JSON.stringify(error)}`);
      }
    }

    function getYearAndWeek(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      let yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      let weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return [d.getUTCFullYear(), weekNo];
    }

    async function deleteImage(event) {
      event.preventDefault();
      event.stopPropagation();
      try {
        const doc = await firebase.firestore().collection("images").doc(event.target.dataset.id).get();
        if (doc.exists) {
          var data = doc.data();
          await firebase.storage().ref().child(data.imagePath).delete();
          await firebase.firestore().collection("images").doc(event.target.dataset.id).update({
            imagePath: null,
            downloadUrl: null
          });
        }
      } catch (error) {
        console.error(`(error): ${JSON.stringify(error)}`);
      }
    }

    function showDeleteImage(event, id) {
      event.preventDefault();
      event.stopPropagation();
      document.querySelector(`#imageDialog-${id}`).classList.add("hidden");
      document.querySelector(`#deleteImageDialog-${id}`).classList.remove("hidden");
    }

    function hideDeleteImage(event, id) {
      event.preventDefault();
      event.stopPropagation();
      document.querySelector(`#imageDialog-${id}`).classList.remove("hidden");
      document.querySelector(`#deleteImageDialog-${id}`).classList.add("hidden");
    }

    function getUUID() {
      let date = new Date().getTime();
      const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        let randomNumber = (date + Math.random() * 16) % 16 | 0;
        date = Math.floor(date / 16);
        return (c == 'x' ? randomNumber : (randomNumber & 0x3 | 0x8)).toString(16);
      });
      return uuid;
    }

    function addEventListeners() {
      $("header, #optionbar, #profilefield").on("mouseover", function () {
        $("#optionbar").removeClass("hidden");
        $("#captionbar").addClass("hidden");
      });
      $("header, #optionbar, #profilefield").on("mouseout", function () {
        $("#optionbar").addClass("hidden");
        $("#captionbar").removeClass("hidden");
      });

      $(".fullscreen").on("click", function () {
        if (screenfull.enabled) {
          screenfull.request();
        }
      });
    }

    function removeEventListeners() {
      $("header, #optionbar, #profilefield").off("mouseover");
      $("header, #optionbar, #profilefield").off("mouseout");
    }
  </script>
  <script type="application/javascript"> var piioData = { appKey: 'sgnclp', encodeSrc: false, domain: 'https://beta.01p-w.com' } </script>
  <script src="https://js.piio.co/sgnclp/piio.min.js"></script>
</body>

</html>
